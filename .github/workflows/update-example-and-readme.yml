name: Update Example and README

on:
  release:
    types: [published]
    paths-ignore:
      - 'example/**'
      - 'README.md'
      - 'version.go'
      - 'go.mod'
      - 'go.sum'
      - '**/!(*.go)'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to commit and push changes
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Get modernc/sqlite version
        id: version
        run: |
          # 使用 go list 命令获取版本，更可靠的方式
          VERSION=$(go list -m -f '{{.Version}}' modernc.org/sqlite)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version to use: $VERSION"

      - name: Update version.go
        run: |
          # 保留完整的版本号（包括 v 前缀）
          FULL_VERSION=${{ steps.version.outputs.version }}
          
          # 确保版本号格式正确
          if [[ "$FULL_VERSION" != v* ]]; then
            FULL_VERSION="v$FULL_VERSION"
          fi
          
          # 更新 version.go 文件，确保引号正确
          sed -i "s|const Version = .*|const Version = \"${FULL_VERSION}\"|g" version.go
          
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add version.go
          if ! git diff --quiet version.go; then
            git commit -m "chore: update version to v${{ steps.version.outputs.version }}"
            echo "version_updated=true" >> $GITHUB_ENV
          else
            echo "No changes in version.go"
            echo "version_updated=false" >> $GITHUB_ENV
          fi

      - name: Update example dependencies
        run: |
          echo "Updating example to version ${{ steps.version.outputs.version }}"
          cd example
          go get github.com/sqlite3ent/sqlite3@${{ steps.version.outputs.version }}
          go mod tidy
          cd ..
          
          git add example/go.mod example/go.sum
          if ! git diff --quiet example/; then
            git commit -m "chore(example): update sqlite3 to v${{ steps.version.outputs.version }}"
            echo "example_updated=true" >> $GITHUB_ENV
          else
            echo "No changes in example dependencies"
            echo "example_updated=false" >> $GITHUB_ENV
          fi

      - name: Update README version
        run: |
          echo "Updating README.md to version ${{ steps.version.outputs.version }}"
          sed -i "s|Current version: v[0-9.]*|Current version: ${{ steps.version.outputs.version }}|g" README.md
          if ! git diff --quiet README.md; then
            git add README.md
            git commit -m "docs: update version in README to v${{ steps.version.outputs.version }}"
            echo "readme_updated=true" >> $GITHUB_ENV
          else
            echo "No changes in README"
            echo "readme_updated=false" >> $GITHUB_ENV
          fi

      - name: Push changes
        if: env.version_updated == 'true' || env.example_updated == 'true' || env.readme_updated == 'true'
        run: |
          echo "Creating tag ${{ steps.version.outputs.version }}"
          git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.version }}"