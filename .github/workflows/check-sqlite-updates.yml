name: Process SQLite Update

on:
  # 由 Dependabot 的 PR 触发
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - 'go.mod'
      - 'go.sum'
    branches: [ main ]
  # 手动触发
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to process'
        required: true
        default: 'main'

jobs:
  process-update:
    # 处理 Dependabot 的 PR（包含 modernc.org/sqlite 更新）或手动触发
    if: |
      (github.event_name == 'pull_request_target' && 
       github.actor == 'dependabot[bot]' && 
       contains(github.event.pull_request.title, 'modernc.org/sqlite')) ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code - PR触发
        if: github.event_name == 'pull_request_target'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Checkout code - 手动触发
        if: github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.21

      - name: Get modernc/sqlite version
        id: version
        run: |
          # 使用 go list 命令获取版本，更可靠的方式
          VERSION=$(go list -m -f '{{.Version}}' modernc.org/sqlite)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version to use: ${VERSION}"

      - name: Update version.go
        run: |
          # 保留完整的版本号（包括 v 前缀）
          FULL_VERSION=${{ steps.version.outputs.version }}
          
          # 确保版本号格式正确
          if [[ "$FULL_VERSION" != v* ]]; then
            FULL_VERSION="v$FULL_VERSION"
          fi
          
          # 更新 version.go 文件，确保引号正确
          sed -i "s|const Version = .*|const Version = \"${FULL_VERSION}\"|g" version.go
          
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add version.go
          if ! git diff --staged --quiet; then
            git commit -m "chore: update version to ${FULL_VERSION}"
            git push
          else
            echo "No changes in version.go"
          fi

      - name: Update example dependencies
        run: |
          cd example
          go get github.com/sqlite3ent/sqlite3@${{ steps.version.outputs.version }}
          go mod tidy
          cd ..
          
          git add example/go.mod example/go.sum
          if ! git diff --staged --quiet; then
            git commit -m "chore(example): update sqlite3 to ${{ steps.version.outputs.version }}"
            git push
          else
            echo "No changes in example dependencies"
          fi

      - name: Update PR title and body
        if: github.event_name == 'pull_request_target'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.pull_request.number }},
              title: `chore: update modernc/sqlite to ${{ steps.version.outputs.version }}`,
              body: `This PR updates modernc.org/sqlite to ${{ steps.version.outputs.version }}\n\n- [x] Updated go.mod\n- [x] Updated version.go\n- [x] Updated example dependencies\n\nAuto-generated by GitHub Actions.`
            })

      - name: Run tests
        run: go test -v ./...

      - name: Merge PR
        if: github.event_name == 'pull_request_target'
        run: |
          gh pr merge --rebase "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}