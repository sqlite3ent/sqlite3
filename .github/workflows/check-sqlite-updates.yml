name: Process SQLite Update

on:
  # 由 Dependabot 的 PR 触发
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - 'go.mod'
      - 'go.sum'
    branches: [ main ]

jobs:
  process-update:
    # 仅处理 Dependabot 的 PR 且包含 modernc.org/sqlite 更新
    if: |
      github.actor == 'dependabot[bot]' && 
      contains(github.event.pull_request.title, 'modernc.org/sqlite')
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.21

      - name: Get modernc/sqlite version
        id: version
        run: |
          VERSION=$(grep 'modernc.org/sqlite' go.mod | awk '{print $2}')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version to use: ${VERSION}"

      - name: Update version.go
        run: |
          VERSION=$(echo "${{ steps.version.outputs.version }}" | sed 's/^v//')
          sed -i "s/Version = \".*\"/Version = \"${VERSION}\"/" version.go
          
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add version.go
          if ! git diff --staged --quiet; then
            git commit -m "chore: update version to ${VERSION}"
            git push
          else
            echo "No changes in version.go"
          fi

      - name: Update example dependencies
        run: |
          cd example
          go get github.com/sqlite3ent/sqlite3@${{ steps.version.outputs.version }}
          go mod tidy
          cd ..
          
          git add example/go.mod example/go.sum
          if ! git diff --staged --quiet; then
            git commit -m "chore(example): update sqlite3 to ${{ steps.version.outputs.version }}"
            git push
          else
            echo "No changes in example dependencies"
          fi

      - name: Update PR title and body
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.pull_request.number }},
              title: `chore: update modernc/sqlite to ${{ steps.version.outputs.version }}`,
              body: `This PR updates modernc.org/sqlite to ${{ steps.version.outputs.version }}\n\n- [x] Updated go.mod\n- [x] Updated version.go\n- [x] Updated example dependencies\n\nAuto-generated by GitHub Actions.`
            })
